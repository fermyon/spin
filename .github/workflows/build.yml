# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Rust
on:
  push:
    branches: ["main", "v*"]
    # Also run on tag pushes, as the release.yml doesn't currently run tests
    tags: ["v*"]
  pull_request:
    branches: ["main", "v*"]
    paths-ignore:
      - "docs/**"
      - "README.md"
      - "tests/README.md"

# Serialize workflow runs per ref
# Cancel any outdated, in-flight runs for refs other than 'main'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  CARGO_TERM_COLOR: always

jobs:
  e2e-tests:
    # run on a larger runner for more SSD/resource access
    runs-on: ubuntu-22.04-4core-spin
    if: ${{ github.repository_owner == 'fermyon' }}
    steps:
      - uses: actions/checkout@v3

      - name: setup spin
        run: |
          wget https://spin-release-artifacts.s3.amazonaws.com/spin-canary-linux-amd64.tar.gz -O /tmp/spin-canary-linux-amd64.tar.gz
          mkdir -p /tmp/spin-canary-linux-amd64
          tar -xvf /tmp/spin-canary-linux-amd64.tar.gz -C /tmp/spin-canary-linux-amd64
          mkdir -p target/release
          ls -ltr /tmp/
          cp /tmp/spin-canary-linux-amd64/spin target/release/spin

      - name: Cache Docker images.
        uses: ScribeMD/docker-cache@0.3.6
        id: e2e-toolchain-cache
        with:
          key: docker-e2e-tests-${{ runner.os }}-${{ hashFiles('e2e-tests-toolchain.Dockerfile') }}

      - name: Build e2e tests toolchain image
        if: steps.e2e-cache.outputs.cache-hit != 'true'
        run: |
          docker build -t fermyon/e2e-tests-toolchain -f e2e-tests-toolchain.Dockerfile .

      - name: Build e2e tests image
        run: |
          export E2E_FETCH_SPIN=false
          make build-test-spin-up

      - name: Run e2e tests image
        run: |
          chmod +x `pwd`/target/release/spin
          export E2E_VOLUME_MOUNT="-v `pwd`/target/release/spin:/usr/local/bin/spin"
          make run-test-spin-up